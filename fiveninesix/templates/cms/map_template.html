{% extends "cms/main_template.html" %}
{% load cms_tags %}

{% block stylesheets %}
    {{ block.super }}

    <link rel="stylesheet" href="{{ MEDIA_URL }}jquery-ui/custom.css" type="text/css" />
{% endblock %}

{% block media %}
    {{ block.super }}
    <script src="{{ MEDIA_URL }}jquery-util.js" type="text/javascript"></script>
    <script src="{{ MEDIA_URL }}OpenLayers/OpenLayers.js" type="text/javascript"></script>
    <script src="{{ MEDIA_URL }}cloudmade.js" type="text/javascript"></script>
    <script src="{{ MEDIA_URL }}map.js" type="text/javascript"></script>
    <script src="{{ MEDIA_URL }}jquery.smartresize.js" type="text/javascript"></script>
    <script src="{{ MEDIA_URL }}map-buttons.js" type="text/javascript"></script>

    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
{% endblock %}

{% block scripts %}
    <script type="text/javascript">
        function show_with_streetview(id, feature) {
            var lon = feature.geometry.x;
            var lat = feature.geometry.y;
            var point = $('#map').data('lotmap').getInverseLonLat(lon, lat);

            var pan = new google.maps.StreetViewPanorama(document.getElementById(id), {
                position: new google.maps.LatLng(point.lat, point.lon),
            });
        }

        $(document).ready(function() {
            $('#map').lotmap({
                queryString: 'source=OASIS,Nominatim,Google&owner_type=city',   
                addContentToPopup: function(popup, feature) {
                    // avoid accumulating popup_templates
                    $('.popup_template.copy').remove();

                    // loading....
                    var $loading_clone = $('.popup_loading').clone();
                    $(popup).find('div').append($loading_clone.addClass('copy').show());

                    // get details and show popup
                    $.getJSON('/lots/' + feature.fid +'/details/json/', function(details) {
                        var $clone = $('.popup_template').clone();
                        $clone.find('td[class!=""]').each(function(i) {
                            var class_name = $(this).attr('class');
                            if (class_name === 'links') {
                                $(this).find('#oasislink').attr('href', 'http://www.oasisnyc.net/map.aspx?zoomto=lot:' + details['bbl']);
                            }
                            else {
                                $(this).text(details[class_name]); 
                            }
                        });
                        $loading_clone.remove();
                        $(popup).find('div').append($clone.addClass('copy').show());
                        $clone.find('.tabs').tabs();
                    });

                    // street view
                    show_with_streetview('streetview', feature);
                },
            });

            $('#map_buttons').mapbuttons({
                $map: $('#map'),
            });
        });
    </script>
{% endblock %}

{% block sidebar %}
{% endblock %}

{% block content %}
<div id="content">
    <div id="map_container" style="width:60%; float:left;">
        <div id="map" style="width: 100%; height: 500px;"></div>
        <div id="streetview" style="width: 100%; height: 200px;"></div>
        <iframe src="http://www.facebook.com/plugins/like.php?href=http%3A%2F%2F596acres.org&layout=button_count&show_faces=false&width=50&action=like&height=80" 
            scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:450px; height:80px; padding-top: 5px;" allowTransparency="true">
        </iframe>
    </div>

    <div id="side" style="float: left; width: 35%;">
    {% placeholder "main" %}
    </div>
    <div style="clear: both;"></div>

    <div id="map_buttons" style="z-index: 4999; width: 300px;">
        <div id="political_borders" class="map_button">
            <span class="label">Political Borders</span>
            <div id="political_borders_selector" class="dropdown">
                <ul>
                    <li id="labels" style="border-bottom: 1px solid gray; margin-bottom: 5px;"><input type="checkbox" id="labels_checkbox" /><label for="labels_checkbox">labels</label></li>
                    <li id="none"><input type="radio" id="none_radio" name="political_borders" checked="checked" /><label for="none_radio">none</label></li>
                    <li id="boroughs"><input type="radio" id="boroughs_radio" name="political_borders" /><label for="boroughs_radio">Boroughs</label></li>
                    <li id="city_councils"><input type="radio" id="city_councils_radio" name="political_borders" /><label for="city_councils_radio">City Council Districts</label></li>
                    <li id="community_districts"><input type="radio" id="community_districts_radio" name="political_borders" /><label for="community_districts_radio">Community Districts</label></li>
                </ul>
            </div>
        </div>
    </div>

    <div class="popup_loading" style="display: none; text-align: center; padding-top: 20%;">
        <img src="{{ MEDIA_URL }}img/details_loading.gif" />
    </div>

    <div class="popup_template" style="display: none;">
        <div class="tabs">
            <ul>
                <li><a href="#details">Details</a></li>
                <li><a href="#groups">Groups</a></li>
            </ul>
            <div id="details">
                <table id="popup_details">
                    <tr>
                        <th>address</th>
                        <td class="address"></td>
                    </tr>
                    <tr>
                        <th>zipcode</th>
                        <td class="zipcode"></td>
                    </tr>
                    <tr>
                        <th>block</th>
                        <td class="block"></td>
                    </tr>
                    <tr>
                        <th>lot</th>
                        <td class="lot"></td>
                    </tr>
                    <tr>
                        <th>owner</th>
                        <td class="owner"></td>
                    </tr>
                    <tr>
                        <th>area</th>
                        <td class="area"></td>
                    </tr>
                    <tr>
                        <th>elsewhere</th>
                        <td class="links">
                            <a id="oasislink" target="_blank">OASIS</a>
                        </td>
                    </tr>
                </table>
            </div>
            <div id="groups">
                more soon
            </div>
        </div>
    </div>
</div>
{% endblock %}

