{% extends "cms/main_template.html" %}
{% load cms_tags %}

{% block stylesheets %}
    {{ block.super }}

    <link rel="stylesheet" href="{{ MEDIA_URL }}jquery-ui/custom.css" type="text/css" />
{% endblock %}

{% block media %}
    {{ block.super }}
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>

    <script src="{{ MEDIA_URL }}jquery-util.js" type="text/javascript"></script>
    <script src="{{ MEDIA_URL }}OpenLayers/OpenLayers.js" type="text/javascript"></script>
    <script src="{{ MEDIA_URL }}cloudmade.js" type="text/javascript"></script>
    <script src="{{ MEDIA_URL }}map.js" type="text/javascript"></script>
    <script src="{{ MEDIA_URL }}jquery.smartresize.js" type="text/javascript"></script>
    <script src="{{ MEDIA_URL }}map-buttons.js" type="text/javascript"></script>
    <script src="{{ MEDIA_URL }}geocode.js" type="text/javascript"></script>
    <script src="{{ MEDIA_URL }}search.js" type="text/javascript"></script>
{% endblock %}

{% block scripts %}
    <script type="text/javascript">
        var max_area_range = 100000;

        function show_with_streetview(id, feature) {
            var lon = feature.geometry.x;
            var lat = feature.geometry.y;
            var point = $('#map').data('lotmap').getInverseLonLat(lon, lat);

            $('#' + id).slideDown();
            var pan = new google.maps.StreetViewPanorama(document.getElementById(id), {
                position: new google.maps.LatLng(point.lat, point.lon),
            });
        }

        function load_organize_form($tab, url) {
            $tab.load(url, on_organize_form_submit($tab, url));
        }

        function submit_organize_form($tab, url) {
            $tab.load(url, $tab.find('form').serializeArray(), on_organize_form_submit($tab, url));
        }

        function on_organize_form_submit($tab, url) {
            return function() {
                $tab.find('form').submit(function(e) {
                    submit_organize_form($tab, url);
                    return false;
                });  
            }
        }

        function update_area_display(min, max) {
            if (max === max_area_range) {
                max += '+';
            }
            $('#area span').text(min + ' to ' + max + ' square feet');
        }

        $(document).ready(function() {
            $('#map').lotmap({
                queryString: 'source=OASIS,Nominatim,Google&owner_type=city',   
                addContentToPopup: function(popup, feature) {
                    // loading....
                    var $loading_clone = $('.popup_loading').clone();
                    $(popup).find('div').append($loading_clone.addClass('copy').show());

                    $(popup).load('/lot/' + feature.fid + '/tabs/', function() {
                        // ....done loading
                        $loading_clone.remove();

                        // link to owner tab
                        $(popup).find('.tabs').tabs()
                            .find('tr.owner').click(function() {
                                $(this).parents('.tabs').tabs('select', '#owner');
                                return false;
                            });

                        // form-in-a-tab
                        $organize_tab = $(popup).find('.tabs #organize');
                        $organize_tab.find('a.add_organizer').click(function() {
                            load_organize_form($organize_tab, '/lot/' + feature.fid + '/organizers/add/ajax/');
                            return false;
                        });
                    });

                    // street view
                    show_with_streetview('streetview', feature);
                },

                onFeatureUnselect: function(feature) {
                    $('#streetview').slideUp();
                }
            });

            $('#searchbar').search({
                map: $('#map').data('lotmap'),
                bounds: {
                    left: -74.319, 
                    top: 40.948, 
                    right: -73.584, 
                    bottom: 40.476,
                },
            });

            $('#map_buttons').mapbuttons({
                $map: $('#map'),
            });

            $('#area_slider').slider({
                range: true,
                min: 1,
                max: max_area_range,
                values: [1, max_area_range],
                slide: function(event, ui) {
                    update_area_display(ui.values[0], ui.values[1]);
                },
                change: function(event, ui) {
                    $('#map').data('lotmap').restrictByArea(ui.values[0], ui.values[1]);
                },
            });
            update_area_display(1, max_area_range);
        });
    </script>
{% endblock %}

{% block sidebar %}
{% endblock %}

{% block breadcrumbs %}
{% endblock %}

{% block content %}
<div id="content">
    <div id="map_container" style="width:60%; float:left;">
        <div id="searchbar">
            <div class="warning errorlist" style="display: none;">Sorry, it doesn't seem that the address you entered is in Brooklyn. Try again?</div>
            <span>Search for lots near an address:</span>
            <form style="display: inline-block;">
                <input name="address" type="text" /><input type="submit" value="search" />
            </form>
            <span class="loading" style="display: none;"><img src="{{ MEDIA_URL }}img/loading_small.gif" /></span>
        </div>

        <div id="map_inner">
            <div id="map_buttons">
                <div id="political_borders" class="map_button dropdownable">
                    <span class="label">Political Borders</span>
                    <div id="political_borders_selector" class="dropdown">
                        <ul>
                            <li id="labels" style="border-bottom: 1px solid gray; margin-bottom: 5px;"><input type="checkbox" id="labels_checkbox" /><label for="labels_checkbox">labels</label></li>
                            <li id="none"><input type="radio" id="none_radio" name="political_borders" checked="checked" /><label for="none_radio">none</label></li>
                            <li id="boroughs"><input type="radio" id="boroughs_radio" name="political_borders" /><label for="boroughs_radio">Boroughs</label></li>
                            <li id="city_councils"><input type="radio" id="city_councils_radio" name="political_borders" /><label for="city_councils_radio">City Council Districts</label></li>
                            <li id="community_districts"><input type="radio" id="community_districts_radio" name="political_borders" /><label for="community_districts_radio">Community Districts</label></li>
                        </ul>
                    </div>
                </div>
                <div id="filters" class="map_button dropdownable">
                    <span class="label">Filters</span>
                    <div id="filters_selector" class="dropdown" style="width: 400px; padding: 5px;">
                        <ul>
                            <li id="area" style="margin-bottom: 5px;">
                                <label>area range:</label>
                                <span></span>
                                <div id="area_slider"></div>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div id="map" style="width: 100%; height: 500px;"></div>
        </div>
        <div id="streetview" style="width: 100%; height: 200px; display: none;"></div>
        <div>
            <iframe src="http://www.facebook.com/plugins/like.php?href=http%3A%2F%2F596acres.org&layout=button_count&show_faces=false&width=50&action=like&height=25" 
                scrolling="no" frameborder="0" style="border:none; overflow:hidden; width:50px; height:25px; padding-top: 5px;" allowTransparency="true">
            </iframe>
        </div>
        <div>
            <a href="http://twitter.com/share" class="twitter-share-button" data-text="596 Acres" data-count="horizontal">Tweet</a><script type="text/javascript" src="http://platform.twitter.com/widgets.js"></script>
        </div>
    </div>

    <div id="side" style="float: left; width: 35%;">
    {% placeholder "main" %}
    </div>
    <div style="clear: both;"></div>

    <div class="popup_loading" style="display: none; text-align: center; padding-top: 20%;">
        <img src="{{ MEDIA_URL }}img/loading_large.gif" />
    </div>
</div>
{% endblock %}

